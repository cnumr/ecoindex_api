name: Update OpenAPI spec
on: [pull_request]

jobs:
  generate-openapi:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.8
    - name: Install dependencies
      run: |
        python -m pip install poetry
        poetry install
    - name: "Export openapi specs from app"
      run: |
        echo 'OPENAPI<<EOF' >> $GITHUB_ENV
        poetry run python openapi.py >> $GITHUB_ENV
        echo 'EOF' >> $GITHUB_ENV
    - name: "Write openapi.json file"
      uses: DamianReeves/write-file-action@v1.0
      with:
        path: docs/openapi.json
        contents: |
          echo "${{ env.OPENAPI }}"
        write-mode: overwrite
